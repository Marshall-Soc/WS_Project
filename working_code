## WS Project (thanks to stm vignette for pointers throughout this
  # thought experiment!)##

# Marshall A. Taylor #

# Required packages.
library(NLP)
library(tm)
library(RColorBrewer)
library(SnowballC)
library(ggplot2)
library(graph)
library(grid)
library(Rgraphviz)
library(pheatmap)
library(RWeka)
library(topicmodels)
library(corrplot)
library(fastcluster)
library(ca)
library(servr)
library(LDAvis)
library(stm)

# Reading in and processing data.
data <- read.csv("WS_Data_Input.csv")
data$Lyrics <- gsub("[^[:alnum:]///' ]", " ", data$Lyrics)
processed <- textProcessor(documents=data$Lyrics, metadata=data, lowercase=T, 
                           removestopwords=T, removenumbers=T, removepunctuation=T, 
                           stem=T, sparselevel=1, language="en", verbose=F, 
                           onlycharacter=F, customstopwords=NULL)
out <- prepDocuments(processed$documents, processed$vocab, 
                     processed$meta)
docs <- out$documents
vocab <- out$vocab
meta <- out$meta

# Selecting a model.
pot_models <- selectModel(docs, vocab, K=10, content =~ Band, 
                          init.type="LDA", data=meta, runs=20,
                          seed=16789)
plotModels(pot_models)
best_fit <- pot_models$runout[[1]]

# Playing around...
labelTopics(best_fit)
plot.STM(best_fit, type="perspectives", covarlevels=c(4,5), topics=8)
plot.STM(best_fit, type="summary")
plot.STM(best_fit, type="hist")
best_corr <- topicCorr(best_fit)
plot.topicCorr(best_corr)
best_theta <- thetaPosterior(best_fit, nsims=1)
write.csv(best_theta, file="best_theta.csv")
test <- estimateEffect(1:10 ~ Band, best_fit, meta=meta, uncertainty="Global")
plot.estimateEffect(test, covariate="Band", topics=c(2,5,10), model=best_fit,
                   method="difference", cov.value1="Band1",
                   cov.value2="Band2", 
                   xlab="More Genre1 . . . More Genre2",
                   main="Genre Differences")
plot.estimateEffect(test, covariate="Band", topics=c(5), model=best_fit,
                    method="pointestimate")

# Re-estimating the models to include prevalence.
data2 <- data
data2$Year[data2$Year=="."] <- NA
Year <- as.numeric(as.character(data2$Year))
mean(Year[1:44], na.rm=T)
data2[23, "Year"] <- 1985
data2[40, "Year"] <- 1985
mean(Year[96:112], na.rm=T)
data2[102, "Year"] <- 2004
data2$Year <- as.numeric(as.character(data2$Year))
processed2 <- textProcessor(documents=data2$Lyrics, metadata=data2, lowercase=T, 
                           removestopwords=T, removenumbers=T, removepunctuation=T, 
                           stem=T, sparselevel=1, language="en", verbose=F, 
                           onlycharacter=F, customstopwords=NULL)
out2 <- prepDocuments(processed2$documents, processed2$vocab, 
                     processed2$meta)
docs2 <- out2$documents
vocab2 <- out2$vocab
meta2 <- out2$meta
# Selecting a model.
pot_models2 <- selectModel(docs2, vocab2, K=10, prevalence =~ Band + s(Year), content =~ Band, 
                          init.type="LDA", data=meta2, runs=20,
                          seed=78902)
plotModels(pot_models2)
best_fit2 <- pot_models2$runout[[3]]
test2 <- estimateEffect(1:10 ~ Band+s(Year), best_fit2, meta=meta2, 
                        uncertainty="Global")
plot.estimateEffect(test2, "Year", method="continuous", topics=c(1,2,3))
best_corr2 <- topicCorr(best_fit2)
plot.topicCorr(best_corr2)
plot.STM(best_fit2, type="perspectives", covarlevels=c(4,5), topics=8)

# Some visualizations.
work <- stm(docs2, vocab2, K=10, prevalence =~ Band + s(Year), 
            init.type="LDA", data=meta2,
            seed=78902)
stmBrowser(work, data=meta2, c("Band", "Year"), id="Doc_ID", labeltype="prob", 
           text="Lyrics")
